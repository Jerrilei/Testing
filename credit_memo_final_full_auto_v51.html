<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Credit Memorandum ‚Äî Final Editor v8.3</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f4f7fb;
  --card:#fff;
  --muted:#6b7280;
  --accent:#0b66c3;
  --danger:#ef4444;
  --missing-ring:#facc15;
}

body{
  font-family:Inter,Arial,sans-serif;
  background:var(--bg);
  margin:0;color:#0f172a;
}

.container{
  max-width:1200px;
  margin:0 auto;
  padding:20px 24px 40px;
}

.card{
  background:var(--card);
  border-radius:12px;
  padding:18px 20px;
  margin-bottom:20px;
  box-shadow:0 4px 18px rgba(15,23,42,0.08);
  border:1px solid rgba(15,23,42,0.03);
}

.section-title{
  font-size:18px;font-weight:700;margin:4px 0 12px;
}

label{
  font-size:13px;color:var(--muted);
}

input,textarea,select{
  width:100%;padding:8px 10px;margin-top:4px;
  border-radius:8px;border:1px solid #d1d5db;
  font-size:14px;background:#fff;box-sizing:border-box;
}

textarea{ min-height:80px; resize:vertical; }

.table{
  width:100%;border-collapse:collapse;margin-top:8px;font-size:14px;
}
.table th,.table td{
  padding:8px;border-bottom:1px solid #e5e7eb;vertical-align:top;
}
/* ===== Numeric Columns Right Alignment (Global) ===== */
.table td:nth-child(n+2),
.table th:nth-child(n+2) {
  text-align: right;
}

.table th{
  font-weight:600;text-align:left;background:#f9fafb;
}

.btn{
  background:var(--accent);
  color:#fff;padding:8px 18px;
  border-radius:8px;border:0;cursor:pointer;
  font-size:14px;font-weight:600;
  display:inline-flex;align-items:center;gap:6px;
}
.btn-outline{
  background:transparent;border:2px solid var(--accent);color:var(--accent);
  padding:7px 18px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;
}
.btn:disabled, .btn-outline:disabled{
  opacity:.5;cursor:not-allowed;
}

.header-row{
  display:flex;flex-direction:column;
  align-items:stretch;gap:8px;
}

/* Buyer info layout B */
.buyer-grid{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:18px 24px;
}

.field-col{ display:flex;flex-direction:column;gap:10px; }
.field{ display:flex;flex-direction:column; }
.note{ font-size:12px;color:var(--muted); }
.small{ font-size:12px; }

/* Obligor Ratings 3-column grid */
.obligor-grid{
  display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px;
}

/* Parameters 3-column grid */
.param-grid{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:16px 24px;
  margin-top:8px;
}

/* Floating Chatbot */
#chatFloatBtn{
  position:fixed;right:24px;bottom:24px;
  background:#0b66c3;color:#fff;
  width:54px;height:54px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:24px;cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,0.25);z-index:999;
}
#chatPanel{
  position:fixed;right:24px;bottom:90px;width:320px;
  background:#fff;border-radius:12px;
  box-shadow:0 8px 26px rgba(0,0,0,0.2);
  padding:12px;display:none;z-index:998;
}
#chatPanel textarea{ min-height:70px; }

/* Hide during PDF */
.pdf-hide{ display:none !important; }

/* fetch spinner */
.spinner {
  width: 14px;height:14px;
  border:2px solid #fff;border-top-color:transparent;
  border-radius:50%;
  animation:spin 0.8s linear infinite;
}
@keyframes spin { 100%{ transform:rotate(360deg); } }

/* ===== Onboarding overlay ===== */
.tour-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.18);
  z-index:1000;
  display:none;
}
.tour-card{
  position:fixed;
  max-width:360px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 18px 45px rgba(15,23,42,0.35);
  padding:14px 16px;
  opacity:0;
  transform:translateY(4px);
  transition:opacity .2s ease, transform .2s ease;
}
.tour-step-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.08em;
  color:var(--muted);
  margin-bottom:4px;
}
.tour-title{
  font-size:15px;
  font-weight:600;
  margin-bottom:6px;
}
.tour-body{
  font-size:13px;
  line-height:1.5;
  margin-bottom:10px;
}
.tour-actions{
  display:flex;
  justify-content:flex-end;
  gap:8px;
}
.small-btn{
  font-size:12px;
  padding:6px 12px;
}
</style>
</head>
<body>

<div class="container">

<!-- ========================= -->
<!-- HEADER BLOCK -->
<!-- ========================= -->

<div class="card">
  <div class="header-row">

    <!-- Row 1: Title + Date -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
      <div>
        <h1 id="memoTitle" style="margin:0;font-size:22px;cursor:pointer;">CREDIT MEMORANDUM</h1>
      </div>
      <div style="text-align:right">
        <div class="note">Prepared date</div>
        <div id="prepDate">2025-01-01</div>
      </div>
    </div>

    <!-- Row 2: Subtitle + Export -->
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="note">
        Template aligned to PDF memo. Start with buyer name ‚Üí Fetch Data, then refine and export.
      </div>

      <button class="btn-outline" onclick="exportPDF()">Export PDF</button>
    </div>

  </div> <!-- /header-row -->

  <!-- Buyer lookup row -->
  <div style="display:flex;gap:12px;margin-top:14px;align-items:flex-end">
    <div style="flex:1">
      <label>Buyer name</label>
      <input id="buyerLookup" placeholder="Type buyer name (e.g. PDD Holdings, Walmart)" />
    </div>

    <button class="btn" id="refreshBuyer">Fetch Data</button>
  </div>

  <div style="margin-top:16px" class="section-title">Executive Summary</div>
  <textarea id="execSummary"></textarea>

  <div style="margin-top:12px" class="section-title">Key Highlights</div>
  <textarea id="highlights"></textarea>
</div>

<!-- BUYER INFORMATION -->
<div class="card">
  <div class="section-title">Buyer Information</div>
  <div class="buyer-grid">
    <!-- Column 1: Identity & geography -->
    <div class="field-col">
      <div class="field">
        <label>Borrower / Obligor</label>
        <input id="companyName" />
      </div>
      <div class="field">
        <label>Obligor Legal Name</label>
        <input id="obligorLegalName" />
      </div>
      <div class="field">
        <label>Group / Parent Legal Name</label>
        <input id="groupParentName" />
      </div>
      <div class="field">
        <label>Country</label>
        <input id="country" />
      </div>
      <div class="field">
        <label>Country of Incorporation</label>
        <input id="countryOfIncorp" />
      </div>
    </div>

    <!-- Column 2: Business narrative -->
    <div class="field-col">
      <div class="field">
        <label>Business description</label>
        <textarea id="business"></textarea>
      </div>
      <div class="field">
        <label>Business activities</label>
        <textarea id="coreBusinessActivities"></textarea>
      </div>
      <div class="field">
        <label>Key Customers / Main markets</label>
        <textarea id="coreBusinessCustomers"></textarea>
      </div>
    </div>

    <!-- Column 3: Market data & ratings -->
    <div class="field-col">
      <div class="field">
        <label>Website</label>
        <input id="coreBusinessWebsite" />
      </div>
      <div class="field">
        <label>Market Cap</label>
        <input id="marketCap" />
      </div>
      <div class="field">
        <label>External credit rating</label>
        <input id="externalRating" />
      </div>
      <div class="field">
        <label>Internal Rating (Current)</label>
        <input id="internalRatingCurrent" />
      </div>
      <div class="field">
        <label>Internal Rating (Proposed)</label>
        <input id="internalRatingProposed" />
      </div>
    </div>
  </div>
</div>

<!-- SUMMARY FINANCIALS (‰∏ä‰∏ã‰∏§ÂùóÔºåÂêå‰∏ÄÂç°Áâá) -->
<div class="card">
  <div class="section-title">Financial Highlights (Summary)</div>

  <!-- ‰∏äÔºöTurnover / GP% / EBITDA -->
  <table class="table" id="summaryTopTbl">
    <thead>
      <tr>
        <th>Metric</th>
        <th>2022</th>
        <th>2023</th>
        <th>2024</th>
        <th>23 vs 22</th>
        <th>24 vs 23</th>
      </tr>
    </thead>
    <tbody id="summaryTopBody"></tbody>
  </table>

  <!-- ‰∏ãÔºöDebt / Equity / Free cash flow -->
  <table class="table" id="summaryBottomTbl" style="margin-top:16px;">
    <thead>
      <tr>
        <th>Metric</th>
        <th>2022</th>
        <th>2023</th>
        <th>2024</th>
        <th>23 vs 22</th>
        <th>24 vs 23</th>
      </tr>
    </thead>
    <tbody id="summaryBottomBody"></tbody>
  </table>
</div>

<!-- CREDIT LIMITS + PARAMETERS -->
<div class="card">
  <div class="section-title">Credit Limits</div>
  <table class="table">
    <thead>
      <tr>
        <th>(US$m)</th><th>Existing</th><th>Current utilisation</th><th>Proposed</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>Secured</th>
        <td><input id="limSecExisting" /></td>
        <td><input id="limSecUtil" /></td>
        <td><input id="limSecProp" /></td>
      </tr>
      <tr>
        <th>Residual</th>
        <td><input id="limResExisting" /></td>
        <td><input id="limResUtil" /></td>
        <td><input id="limResProp" /></td>
      </tr>
      <tr>
        <th>Clean</th>
        <td><input id="limCleanExisting" /></td>
        <td><input id="limCleanUtil" /></td>
        <td><input id="limCleanProp" /></td>
      </tr>
      <tr>
        <th>Total</th>
        <td><input id="limTotExisting" /></td>
        <td><input id="limTotUtil" /></td>
        <td><input id="limTotProp" /></td>
      </tr>
    </tbody>
  </table>

  <div class="section-title" style="margin-top:18px;">Parameters</div>
  <div class="param-grid">
    <div class="field">
      <label>Insurer</label>
      <input id="insurer" />
    </div>
    <div class="field">
      <label>Credit Insurance Limit</label>
      <input id="creditInsLimit" />
    </div>
    <div class="field">
      <label>Advance Rate</label>
      <input id="advanceRate" />
    </div>

    <div class="field">
      <label>TCS Rate</label>
      <input id="tcsRate" />
    </div>
    <div class="field">
      <label>Past 12 mth GMV</label>
      <input id="gmvPast12" />
    </div>
    <div class="field">
      <label>Forecast 12 mth GMV</label>
      <input id="gmvForecast12" />
    </div>

    <div class="field">
      <label>Financing term</label>
      <input id="financingTerm" />
    </div>
    <div class="field">
      <label>Supplier Credit Days</label>
      <input id="supplierCreditDays" />
    </div>
    <div class="field">
      <label>Payment History / Delay Days</label>
      <input id="paymentHistory" />
    </div>

    <div class="field">
      <label>Dilution rate</label>
      <input id="dilutionRate" />
    </div>
    <div class="field">
      <label>Peak / Average WC</label>
      <input id="peakAvgWc" />
    </div>
    <div class="field">
      <label>LF Customer Since</label>
      <input id="customerSince" />
    </div>
  </div>
</div>

<!-- FULL FINANCIALS -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div class="section-title">Financial Highlights (Full ‚Äî Credit Metrics)</div>
    <div style="display:flex;gap:10px;">
      <button class="btn" id="refreshAnalysisBtn"
        onclick="refreshAnalysisFromTables()">Refresh Analysis</button>
    </div>
  </div>

  <table class="table" id="finTableFull">
    <thead>
      <tr>
        <th>Metric</th>
        <th>2022</th>
        <th>2023</th>
        <th>2024</th>
        <th>23 vs 22</th>
        <th>24 vs 23</th>
        <th>Latest Quarter</th>
      </tr>
    </thead>
    <tbody id="finBody"></tbody>
  </table>
</div>

<!-- ANALYSIS -->
<div class="card">
  <div class="section-title">Automated Financial Analysis</div>
  <div id="analysisBox" contenteditable="true" style="font-size:14px;line-height:1.5"></div>
  <div class="note" style="margin-top:6px">You can edit the analysis text directly above after the auto-fill.</div>
</div>

<!-- SOURCES -->
<div class="card">
  <div class="section-title">Key Sources (non-editable)</div>
  <div id="sourcesBox" style="font-size:13px;line-height:1.5;color:#374151">
    <div class="note">Populated automatically from the financial analysis. Not editable.</div>
    <ul id="sourcesList" style="padding-left:18px;margin-top:8px"></ul>
  </div>
</div>

<!-- LIQUIDITY -->
<div class="card">
  <div class="section-title">Liquidity Metrics</div>
  <table class="table">
    <tr><th>Metric</th><th>2022</th><th>2023</th><th>2024</th><th>Notes</th></tr>
    <tr>
      <td>Liquidity headroom</td>
      <td><input id="liq22" /></td>
      <td><input id="liq23" /></td>
      <td><input id="liq24" /></td>
      <td><textarea id="liqNotes"></textarea></td>
    </tr>
  </table>
</div>

<!-- OBLIGOR RATINGS -->
<div class="card">
  <div class="section-title">Obligor Ratings</div>
  <div class="obligor-grid">
    <div class="field">
      <label>Internal Score</label>
      <input id="intScore" />
    </div>
    <div class="field">
      <label>External Rating</label>
      <input id="extRating2" />
    </div>
    <div class="field">
      <label>Rationale</label>
      <textarea id="ratingRationale"></textarea>
    </div>
  </div>
</div>

<!-- RECOMMENDATION -->
<div class="card">
  <div class="section-title">Recommendation & Action Plan</div>
  <textarea id="recommend"></textarea>
</div>

<!-- RISKS -->
<div class="card">
  <div class="section-title">Key Risks & Mitigants</div>
  <textarea id="risks"></textarea>
</div>

</div><!-- /container -->

<!-- FLOATING CHATBOT BUTTON -->
<div id="chatFloatBtn" title="Ask about the analysis">üí¨</div>
<div id="chatPanel">
  <div style="font-weight:600;margin-bottom:6px">Analyst Chatbot</div>
  <div class="note" style="margin-bottom:4px">Quick questions about the financial analysis & sources.</div>
  <textarea id="floatQ" placeholder="e.g. Which 10-K section explains the EBITDA decline?"></textarea>
  <button class="btn" id="floatAsk" style="margin-top:6px;width:100%">Ask</button>
  <div id="floatA" style="margin-top:8px;font-size:13px;color:#374151">‚Äî</div>
</div>

<!-- ONBOARDING OVERLAY -->
<div id="tourOverlay" class="tour-overlay">
  <div id="tourCard" class="tour-card">
    <div id="tourStepLabel" class="tour-step-label"></div>
    <div id="tourTitle" class="tour-title"></div>
    <div id="tourBody" class="tour-body"></div>
    <div class="tour-actions">
      <button id="tourSkipBtn" class="btn-outline small-btn">Skip</button>
      <button id="tourNextBtn" class="btn small-btn">Next</button>
    </div>
  </div>
</div>

<!-- PDF EXPORT LIBS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// ===== Export PDF =====
async function exportPDF() {
  const { jsPDF } = window.jspdf;

  const chatBtn = document.getElementById("chatFloatBtn");
  const chatPanel = document.getElementById("chatPanel");
  const tourOverlay = document.getElementById("tourOverlay");
  if (chatBtn) chatBtn.classList.add("pdf-hide");
  if (chatPanel) chatPanel.classList.add("pdf-hide");
  if (tourOverlay) tourOverlay.classList.add("pdf-hide");

  const container = document.querySelector(".container");

  // Â∞ÜËæìÂÖ•Êéß‰ª∂ÊõøÊç¢ÊàêÁ∫ØÊñáÊú¨ div
  const replacements = [];
  const controls = container.querySelectorAll("input, textarea, select");
  controls.forEach(el => {
    const style = window.getComputedStyle(el);
    let text = "";
    if (el.tagName === "SELECT") {
      const sel = el;
      if (sel.selectedIndex >= 0) {
        text = sel.options[sel.selectedIndex].text;
      }
    } else {
      text = el.value || "";
    }

    const span = document.createElement("div");
    span.textContent = text;
    span.style.minHeight = el.offsetHeight + "px";
    span.style.whiteSpace = "pre-wrap";
    span.style.fontSize = style.fontSize;
    span.style.lineHeight = style.lineHeight;
    span.style.fontFamily = style.fontFamily;
    span.style.padding = "4px 0";
    span.style.border = "none";
    span.style.background = "transparent";

    const origDisplay = el.style.display;
    el.style.display = "none";
    el.parentNode.insertBefore(span, el.nextSibling);

    replacements.push({ el, span, origDisplay });
  });

  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  const marginX = 10;  // mm
  const marginY = 10;  // mm
  const usableWidth = pageWidth - marginX * 2;
  const usableHeight = pageHeight - marginY * 2;

  const canvas = await html2canvas(container, { scale: 2, useCORS: true });
  const imgData = canvas.toDataURL("image/png");
  const imgProps = pdf.getImageProperties(imgData);

  const imgWidthPx = imgProps.width;
  const imgHeightPx = imgProps.height;

  const imgHeightMm = (imgHeightPx * usableWidth) / imgWidthPx;

  let heightLeft = imgHeightMm;
  let position = marginY;

  pdf.addImage(imgData, "PNG", marginX, position, usableWidth, imgHeightMm);
  heightLeft -= usableHeight;

  while (heightLeft > 0) {
    pdf.addPage();
    position = marginY - (imgHeightMm - heightLeft);
    pdf.addImage(imgData, "PNG", marginX, position, usableWidth, imgHeightMm);
    heightLeft -= usableHeight;
  }

  pdf.save("credit_memo.pdf");

  // ÊÅ¢Â§çËæìÂÖ•Êéß‰ª∂
  replacements.forEach(({ el, span, origDisplay }) => {
    if (span && span.parentNode) span.parentNode.removeChild(span);
    el.style.display = origDisplay || "";
  });

  if (chatBtn) chatBtn.classList.remove("pdf-hide");
  if (chatPanel) chatPanel.classList.remove("pdf-hide");
  if (tourOverlay) tourOverlay.classList.remove("pdf-hide");
}
</script>

<script>
// ===== Onboarding =====
const TOUR_KEY = "credit_memo_tour_v8_3";
let currentTourStep = 0;

const TOUR_STEPS = [
  {
    id:0,
    type:"modal",
    stepLabel:"Step 0 ‚Äî Welcome",
    title:"Welcome!",
    body:"This memo tool automatically fetches financials, narrative, key metrics and tables from public filings. Click Next for a quick 3-step tour."
  },
  {
    id:1,
    type:"anchor",
    targetId:"buyerLookup",
    stepLabel:"Step 1 ‚Äî Enter buyer name",
    title:"Step 1 ‚Äî Enter buyer name",
    body:"Start by typing the obligor name here. This is required before auto-fetching financials and tables."
  },
  {
    id:2,
    type:"anchor",
    targetId:"refreshBuyer",
    stepLabel:"Step 2 ‚Äî Fetch data",
    title:"Step 2 ‚Äî Fetch data",
    body:"Click ‚ÄúFetch Data‚Äù to retrieve filings, financial metrics, liquidity, ratings and narrative directly from public sources."
  },
  {
    id:3,
    type:"anchor",
    targetId:"refreshAnalysisBtn",
    stepLabel:"Step 3 ‚Äî Refresh analysis",
    title:"Step 3 ‚Äî Refresh analysis",
    body:"After reviewing or adjusting the financial tables, click ‚ÄúRefresh Analysis‚Äù to regenerate a fully updated credit analysis using the final numbers."
  }
];

function placeTourCard(step, opts = {}) {
  const { skipScroll = false } = opts;
  const overlay = document.getElementById("tourOverlay");
  const card = document.getElementById("tourCard");
  if (!overlay || !card) return;
  if (!step) { endTour(); return; }

  overlay.style.display = "block";

  // MODAL STEP
  if (step.type === "modal" || !step.targetId) {
    card.style.position = "fixed";
    card.style.top = "50%";
    card.style.left = "50%";
    card.style.transform = "translate(-50%, -50%)";
    card.style.opacity = "1";
    card.style.pointerEvents = "auto";
    return;
  }

  const target = document.getElementById(step.targetId);
  if (!target) {
    card.style.position = "fixed";
    card.style.top = "50%";
    card.style.left = "50%";
    card.style.transform = "translate(-50%, -50%)";
    card.style.opacity = "1";
    card.style.pointerEvents = "auto";
    return;
  }

  card.style.opacity = "0";
  card.style.pointerEvents = "none";

  if (!skipScroll) {
    try {
      target.scrollIntoView({ behavior: "smooth", block: "center" });
    } catch(e) {
      target.scrollIntoView();
    }
  }

  setTimeout(() => {
    const rect = target.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const cardWidth = 360;
    const cardHeight = 200;

    let left = rect.left;
    let top = rect.bottom + 12;

    if (step.id === 3) {
      const btnRect = rect;
      const btnCenter = btnRect.left + btnRect.width / 2;
      left = btnCenter - cardWidth / 2;
      top = btnRect.bottom + 12;

      if (left < 20) left = 20;
      if (left + cardWidth > viewportWidth - 20) {
        left = viewportWidth - cardWidth - 20;
      }

      if (top + cardHeight > viewportHeight - 20) {
        top = btnRect.top - cardHeight - 12;
      }
    } else {
      if (left + cardWidth > viewportWidth - 20) {
        left = viewportWidth - cardWidth - 20;
      }
      if (left < 20) left = 20;

      if (top + cardHeight > viewportHeight - 20) {
        top = rect.top - cardHeight - 12;
      }
      if (top < 20) top = 20;
    }

    card.style.position = "fixed";
    card.style.top = top + "px";
    card.style.left = left + "px";
    card.style.transform = "translateY(0)";
    card.style.opacity = "1";
    card.style.pointerEvents = "auto";
  }, skipScroll ? 100 : 300);
}

function renderTourStep() {
  const overlay = document.getElementById("tourOverlay");
  const card = document.getElementById("tourCard");
  const labelEl = document.getElementById("tourStepLabel");
  const titleEl = document.getElementById("tourTitle");
  const bodyEl = document.getElementById("tourBody");
  const nextBtn = document.getElementById("tourNextBtn");

  if (!overlay || !card) return;
  const step = TOUR_STEPS[currentTourStep];
  if (!step) { endTour(); return; }

  labelEl.textContent = step.stepLabel || "";
  titleEl.textContent = step.title || "";
  bodyEl.textContent = step.body || "";

  if (nextBtn) {
    nextBtn.textContent = (currentTourStep === TOUR_STEPS.length - 1) ? "Done" : "Next";
  }

  placeTourCard(step, { skipScroll: false });
}

function endTour() {
  const overlay = document.getElementById("tourOverlay");
  const card = document.getElementById("tourCard");
  if (overlay) overlay.style.display = "none";
  if (card) {
    card.style.opacity = "0";
    card.style.pointerEvents = "none";
  }
  try {
    localStorage.setItem(TOUR_KEY, "done");
  } catch(e){}
}

function startTour(startIndex=0) {
  currentTourStep = startIndex;
  renderTourStep();
}

function resetTour() {
  try {
    localStorage.removeItem(TOUR_KEY);
  } catch(e){}
  startTour(0);
}

function maybeStartTourOnLoad() {
  try {
    const flag = localStorage.getItem(TOUR_KEY);
    if (!flag) {
      startTour(0);
    }
  } catch(e){
    startTour(0);
  }
}

window.addEventListener("resize", () => {
  const overlay = document.getElementById("tourOverlay");
  if (!overlay || overlay.style.display !== "block") return;
  const step = TOUR_STEPS[currentTourStep];
  if (!step) return;
  placeTourCard(step, { skipScroll: true });
});
</script>

<script>
// ===== ‰∏öÂä°ÈÄªËæë JS =====
function linkify(text) {
  const urlRegex = /(https?:\/\/[^\s)"]+)/g;
  return text.replace(urlRegex, url => {
    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
  });
}

const WORKER_URL = "https://credit-memo-proxy.jerrizhou.workers.dev";

function extractContentFromResponses(data) {
  if (!data) return "";
  if (typeof data.output_text === "string" && data.output_text.trim()) {
    return data.output_text;
  }
  if (Array.isArray(data.output)) {
    for (const item of data.output) {
      if (item && item.type === "message" && Array.isArray(item.content)) {
        return item.content.map(part => {
          if (!part) return "";
          if (typeof part.text === "string") return part.text;
          if (part.type === "output_text" && typeof part.output_text === "string") return part.output_text;
          return "";
        }).join("");
      }
      if (item && typeof item.content === "string") {
        return item.content;
      }
    }
  }
  if (data.choices && data.choices[0] && data.choices[0].message && typeof data.choices[0].message.content === "string") {
    return data.choices[0].message.content;
  }
  return "";
}

function toNum(x) {
  if (x === null || x === undefined) return null;
  let s = String(x).trim();
  if (!s) return null;
  s = s.replace(/,/g, '').trim();
  s = s.replace(/(USD|US\$|RMB|CNY|HKD|HK\$|EUR|EUR\$|GBP|¬£|‚Ç¨|¬•|\$)/gi, '').trim();

  let multiplier = 1;
  const unitMatch = s.match(/(billion|bn|million|mn|m|thousand|k)/i);
  if (unitMatch) {
    const u = unitMatch[1].toLowerCase();
    if (u === 'billion' || u === 'bn') multiplier = 1000;
    else if (u === 'million' || u === 'mn' || u === 'm') multiplier = 1;
    else if (u === 'thousand' || u === 'k') multiplier = 0.001;
    s = s.replace(unitMatch[0], '').trim();
  }
  if (!s) return null;
  const n = Number(s);
  if (!Number.isFinite(n)) return null;
  return n * multiplier;
}

function safeVal(id) {
  var el = document.getElementById(id);
  return el && typeof el.value === 'string' ? el.value : '';
}

// ‰ø°Áî®ÊåáÊ†áË°®È°∫Â∫è
const CREDIT_METRICS_ORDER = [
  "Turnover",
  "GP",
  "GP%",
  "EBITDA",
  "EBITDA margin %",
  "Net profit",
  "Net Profit %",
  "Cash & Bank",
  "Inventory",
  "Debt - Current",
  "Debt - Non-current",
  "Equity",
  "Free cash flow",
  "Cash Conv. Cycle (days)",
  "Net debt / EBITDA (x)",
  "EBITDA / Interest (x)",
  "Current ratio (x)"
];

const CREDIT_METRIC_PATTERNS = {
  "Turnover": [/turnover/i, /total revenue/i, /revenue/i, /net sales/i],
  "GP": [/gross\s*profit/i, /\bGP\b/i],
  "EBITDA": [/\bEBITDA\b/i, /operating\s*income/i, /operating\s*profit/i],
  "Net profit": [/net\s*income/i, /net\s*profit/i, /profit attributable/i],
  "Cash & Bank": [/cash/i, /cash & equivalents/i, /cash & cash equivalents/i, /bank\b/i],
  "Inventory": [/inventory/i, /inventories/i],
  "Debt - Current": [/current\s+debt/i, /short[-\s]?term\s+debt/i, /short[-\s]?term\s+borrowings/i],
  "Debt - Non-current": [/non[-\s]?current\s+debt/i, /long[-\s]?term\s+debt/i, /long[-\s]?term\s+borrowings/i],
  "Equity": [/total\s+equity/i, /shareholders'?\s+equity/i, /net\s+assets/i],
  "Free cash flow": [/free\s*cash*s*flow/i, /\bFCF\b/i],
  "Cash Conv. Cycle (days)": [/cash conversion cycle/i],
  "Net debt / EBITDA (x)": [/net debt \/ EBITDA/i],
  "EBITDA / Interest (x)": [/EBITDA \/ interest/i],
  "Current ratio (x)": [/current ratio/i]
};

// ====== ÊûÑÂª∫ Full ‰ø°Áî®ÊåáÊ†áË°® ======
function buildCreditMetricsTable() {
  const tbody = document.getElementById('finBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  CREDIT_METRICS_ORDER.forEach(name => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${name}</td>
      <td><input data-metric="${name}" data-year="2022" /></td>
      <td><input data-metric="${name}" data-year="2023" /></td>
      <td><input data-metric="${name}" data-year="2024" /></td>
      <td></td>
      <td></td>
      <td></td>`;
    tbody.appendChild(tr);
  });
}

function setMetricValue(metricName, year, value) {
  const sel = 'input[data-metric="' + metricName + '"][data-year="' + year + '"]';
  const el = document.querySelector(sel);
  if (!el) return;
  if (value == null || value === '') return;
  el.value = value;
}

function findRowByPatterns(rows, patterns) {
  if (!Array.isArray(rows)) return null;
  for (const row of rows) {
    const name = String(row.metric || '').toLowerCase();
    for (const p of patterns) {
      if (p.test(name)) return row;
    }
  }
  return null;
}

// ====== ‰ªé AI full_financials Êò†Â∞ÑÂà∞‰ø°Áî®ÊåáÊ†áË°® ======
function applyCreditMetricsFromFull(fullRows) {
  if (!Array.isArray(fullRows)) fullRows = [];
  const revRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Turnover"]);
  const gpRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["GP"]);
  const ebitdaRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["EBITDA"]);
  const npRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Net profit"]);
  const cashRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Cash & Bank"]);
  const invRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Inventory"]);
  const debtCurRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Debt - Current"]);
  const debtNcRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Debt - Non-current"]);
  const eqRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Equity"]);
  const fcfRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Free cash flow"]);
  const cccRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Cash Conv. Cycle (days)"]);
  const ndEbitdaRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Net debt / EBITDA (x)"]);
  const ebitdaIntRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["EBITDA / Interest (x)"]);
  const curRatioRow = findRowByPatterns(fullRows, CREDIT_METRIC_PATTERNS["Current ratio (x)"]);

  const years = [2022, 2023, 2024];

  function val(row, year) {
    if (!row) return null;
    const key = 'y' + String(year);
    return row[key];
  }

  years.forEach(y => {
    const ys = String(y);
    setMetricValue("Turnover", ys, val(revRow, y));
    setMetricValue("GP", ys, val(gpRow, y));
    setMetricValue("EBITDA", ys, val(ebitdaRow, y));
    setMetricValue("Net profit", ys, val(npRow, y));
    setMetricValue("Cash & Bank", ys, val(cashRow, y));
    setMetricValue("Inventory", ys, val(invRow, y));
    setMetricValue("Debt - Current", ys, val(debtCurRow, y));
    setMetricValue("Debt - Non-current", ys, val(debtNcRow, y));
    setMetricValue("Equity", ys, val(eqRow, y));
    setMetricValue("Free cash flow", ys, val(fcfRow, y));
    setMetricValue("Cash Conv. Cycle (days)", ys, val(cccRow, y));
    setMetricValue("Net debt / EBITDA (x)", ys, val(ndEbitdaRow, y));
    setMetricValue("EBITDA / Interest (x)", ys, val(ebitdaIntRow, y));
    setMetricValue("Current ratio (x)", ys, val(curRatioRow, y));
  });

  // Ê†πÊçÆ Turnover/GP/EBITDA/Net profit Ëá™Âä®ÁÆó Margin Âíå Net debt / EBITDAÔºàÂ¶ÇÊú™ÁªôÂá∫Ôºâ
  years.forEach(y => {
    const ys = String(y);
    const rev = toNum(document.querySelector('input[data-metric="Turnover"][data-year="' + ys + '"]')?.value);
    const gp = toNum(document.querySelector('input[data-metric="GP"][data-year="' + ys + '"]')?.value);
    const ebitda = toNum(document.querySelector('input[data-metric="EBITDA"][data-year="' + ys + '"]')?.value);
    const np = toNum(document.querySelector('input[data-metric="Net profit"][data-year="' + ys + '"]')?.value);
    const cash = toNum(document.querySelector('input[data-metric="Cash & Bank"][data-year="' + ys + '"]')?.value);
    const debtCur = toNum(document.querySelector('input[data-metric="Debt - Current"][data-year="' + ys + '"]')?.value);
    const debtNc = toNum(document.querySelector('input[data-metric="Debt - Non-current"][data-year="' + ys + '"]')?.value);

    if (rev && gp != null) {
      setMetricValue("GP%", ys, ((gp / rev) * 100).toFixed(1));
    }
    if (rev && ebitda != null) {
      setMetricValue("EBITDA margin %", ys, ((ebitda / rev) * 100).toFixed(1));
    }
    if (rev && np != null) {
      setMetricValue("Net Profit %", ys, ((np / rev) * 100).toFixed(1));
    }

    const totalDebt = (debtCur || 0) + (debtNc || 0);
    const netDebt = (totalDebt && cash != null) ? (totalDebt - cash) : null;
    const ndMetric = document.querySelector('input[data-metric="Net debt / EBITDA (x)"][data-year="' + ys + '"]');
    if (netDebt != null && ebitda) {
      const ratio = netDebt / ebitda;
      if (ndMetric && !ndMetric.value) ndMetric.value = ratio.toFixed(2);
    }
  });
}

// ====== ‰ªé Full Ë°®ÈáçÂª∫ SummaryÔºàÂê´ Debt ÂÖ¨ÂºèÔºâ ======
function getFullMetricValue(metricName, year) {
  const selector = 'input[data-metric="' + metricName + '"][data-year="' + year + '"]';
  const el = document.querySelector(selector);
  if (!el) return null;
  return toNum(el.value);
}

function rebuildSummaryTables() {
  const topBody = document.getElementById('summaryTopBody');
  const bottomBody = document.getElementById('summaryBottomBody');
  if (!topBody || !bottomBody) return;

  topBody.innerHTML = '';
  bottomBody.innerHTML = '';

  const years = [2022, 2023, 2024];

  function buildRow(label, key, isDebt) {
    const vals = {};
    years.forEach(y => {
      if (isDebt) {
        const cur = getFullMetricValue("Debt - Current", String(y));
        const nc = getFullMetricValue("Debt - Non-current", String(y));
        if (cur == null && nc == null) {
          vals[y] = null;
        } else {
          vals[y] = (cur || 0) + (nc || 0);
        }
      } else {
        vals[y] = getFullMetricValue(key, String(y));
      }
    });

    let yoy23 = '-';
    let yoy24 = '-';
    const v22 = vals[2022];
    const v23 = vals[2023];
    const v24 = vals[2024];

    if (v22 != null && v23 != null && v22 !== 0) {
      yoy23 = ((v23 - v22) / v22 * 100).toFixed(1) + '%';
    }
    if (v23 != null && v24 != null && v23 !== 0) {
      yoy24 = ((v24 - v23) / v23 * 100).toFixed(1) + '%';
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${label}</td>
      <td>${vals[2022] != null ? vals[2022] : ''}</td>
      <td>${vals[2023] != null ? vals[2023] : ''}</td>
      <td>${vals[2024] != null ? vals[2024] : ''}</td>
      <td>${yoy23}</td>
      <td>${yoy24}</td>
    `;
    return tr;
  }

  // ‰∏äÔºöTurnover / GP% / EBITDA
  topBody.appendChild(buildRow("Turnover", "Turnover", false));
  topBody.appendChild(buildRow("GP%", "GP%", false));
  topBody.appendChild(buildRow("EBITDA", "EBITDA", false));

  // ‰∏ãÔºöDebt / Equity / Free cash flow
  bottomBody.appendChild(buildRow("Debt", "Debt", true)); // Debt = Current + Non-current
  bottomBody.appendChild(buildRow("Equity", "Equity", false));
  bottomBody.appendChild(buildRow("Free cash flow", "Free cash flow", false));
}

// ====== Âè™ÂØπ Full Ë°®ÁÆó YoYÔºåSummary Ëá™Â∑±ÈáçÂª∫ ======
function recomputeYoYFromTables() {
  const fullRows = document.querySelectorAll('#finBody tr');
  fullRows.forEach(tr => {
    const tds = tr.querySelectorAll('td');
    if (tds.length >= 7) {
      const y22Input = tds[1].querySelector('input');
      const y23Input = tds[2].querySelector('input');
      const y24Input = tds[3].querySelector('input');
      const y22 = toNum(y22Input && y22Input.value);
      const y23 = toNum(y23Input && y23Input.value);
      const y24 = toNum(y24Input && y24Input.value);
      let yoy23 = '-', yoy24 = '-';
      if (y22 != null && y23 != null && y22 !== 0) yoy23 = ((y23 - y22) / y22 * 100).toFixed(1) + '%';
      if (y23 != null && y24 != null && y23 !== 0) yoy24 = ((y24 - y23) / y23 * 100).toFixed(1) + '%';
      tds[4].textContent = yoy23;
      tds[5].textContent = yoy24;
    }
  });

  // Full Êõ¥Êñ∞‰πãÂêéÔºåÈáçÂª∫ SummaryÔºàÂê´ Debt ÂÖ¨ÂºèÔºâ
  rebuildSummaryTables();
}

// ====== ‰ªé Analysis ÈáåÊèêÂèñ Source ======
function populateSourcesFromAnalysis() {
  const listEl = document.getElementById('sourcesList');
  const box = document.getElementById('analysisBox');
  if (!listEl || !box) return;
  const html = box.innerHTML || '';
  const regex = /(Source:\s*[^)<\n]+|\(Source:\s*[^)]+\))/gi;
  const seen = new Set();
  const items = [];
  let m;
  while ((m = regex.exec(html)) !== null) {
    let raw = m[0];
    raw = raw.replace(/^\(/, '').replace(/\)$/, '');
    const parts = raw.split(/Source:\s*/i);
    const text = (parts[1] || parts[0] || '').trim();
    if (!text || seen.has(text.toLowerCase())) continue;
    seen.add(text.toLowerCase());
    const q = encodeURIComponent(text);
    const url = "https://www.google.com/search?q=" + q;
    items.push({ label: text, url });
  }
  listEl.innerHTML = '';
  if (!items.length) {
    const li = document.createElement('li');
    li.textContent = 'No explicit sources detected in the analysis text.';
    listEl.appendChild(li);
    return;
  }
  items.forEach(it => {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = it.url;
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.textContent = it.label;
    li.appendChild(a);
    listEl.appendChild(li);
  });
}

// ====== Auto Fetch via Worker ======
async function autoFetchBuyer() {
  const buyer = (safeVal('buyerLookup') || '').trim();
  if (!buyer) {
    alert('Please enter buyer name first');
    return;
  }

  const btn = document.getElementById('refreshBuyer');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Fetching‚Ä¶';
  }

  const systemPrompt = `
You are a Senior Credit Analyst generating a complete credit memo dataset for a trade finance credit committee. 
Act as an experienced auditor-level financial analyst and credit risk expert.

====================================================================
1. DATA SOURCE PRIORITY (STRICT)
====================================================================
Always obtain and reconcile data in this exact priority order:

1) Company official filings (highest):
   - Annual report, Form 20-F, Form 10-K
   - Interim/quarterly report, Form 10-Q
   - Results announcements / earnings releases
   - Investor presentations (secondary use only)

2) If a metric is missing but can be derived from the statements, YOU MUST compute it:
   Examples:
   - GP = Revenue ‚Äì Cost of sales
   - EBITDA = Operating profit + Depreciation + Amortisation
   - EBITDA margin = EBITDA / Revenue
   - Net profit margin = Net profit / Revenue
   - Free cash flow = Operating cash flow ‚Äì Capex
   - Cash conversion cycle = DIO + DSO ‚Äì DPO
   - Net debt = (Current debt + Non-current debt) ‚Äì Cash & Bank
   - Net debt / EBITDA = Net debt / EBITDA
   - Current ratio = Current assets / Current liabilities

3) Credible third-party financial portals (fallback only, never override filings):
   - Yahoo Finance, MarketWatch, Bloomberg summaries, exchange data
   - Use only for market cap, share price, missing FX rates.
   - NEVER override values from official filings.

Never fabricate numeric values. Only compute if derivable. If still unavailable, leave null.

====================================================================
2. REPORTING PERIODS
====================================================================
If the company has latest YTD / interim data (e.g., 2025 Q3 YTD), extract:

- FY2022 (full-year)
- FY2023 (full-year)
- FY2024 (full-year, or latest available FY)
- Latest YTD (e.g., 2025 Q3 YTD)
- Prior-year comparable YTD (2024 Q3 YTD)

PL & CF ‚Üí treat YTD as cumulative  
BS ‚Üí treat each period as point-in-time snapshot (do NOT sum BS).

If NO latest YTD exists ‚Üí extract at minimum FY2022, FY2023, FY2024.

====================================================================
3. METRIC DEFINITIONS (CREDIT STANDARD)
====================================================================
Normalize financial statement items into:

INCOME STATEMENT:
- Turnover (operating revenue only; exclude GMV and financial income)
- GP
- GP%
- EBITDA
- EBITDA margin %
- Net profit
- Net profit %

BALANCE SHEET:
- Cash & Bank (exclude restricted cash)
- Inventory
- Debt ‚Äì Current (short-term interest-bearing)
- Debt ‚Äì Non-current (long-term interest-bearing)
- Equity

CASH FLOW:
- Free cash flow = OCF ‚Äì Capex

CREDIT METRICS:
- Cash Conv. Cycle = DIO + DSO ‚Äì DPO
- Net debt / EBITDA
- EBITDA / Interest
- Current ratio

====================================================================
4. CURRENCY & FX HANDLING
====================================================================
- ALWAYS start from values in the native reporting currency.
- If FX rate is disclosed in filings ‚Üí MUST use it.
- If no FX disclosed ‚Üí infer FX rate from official tables or consistent USD reconciliation.
- Convert all table outputs to USD millions (US$m).
- If conversion impossible ‚Üí keep consistent original currency.

====================================================================
5. EXTERNAL CREDIT RATINGS
====================================================================
- Use ONLY official ratings from S&P, Moody‚Äôs, Fitch, or reputable local agencies.
- If no rating exists ‚Üí leave external_rating empty (or ‚ÄúNot rated‚Äù only in narrative).
- NEVER create an implied rating.

====================================================================
6. NON-FINANCIAL NARRATIVE
====================================================================
Extract and summarise from filings and credible sources:

- Business description
- Business activities
- Key customers / markets
- Group structure
- Market cap (from exchange or trusted portals)
- External credit rating (if any)
- 3‚Äì5 risks with mitigants

====================================================================
7. OUTPUT JSON FORMAT (STRICT ‚Äî DO NOT MODIFY)
====================================================================
You MUST return a JSON object in EXACTLY this structure:

{
  "exec_summary": "",
  "key_highlights": "",

  "buyer": {
    "borrower": "",
    "obligor_legal_name": "",
    "group_parent": "",
    "country": "",
    "country_of_incorp": "",
    "business_description": "",
    "business_activities": "",
    "key_customers_main_countries": "",
    "website": "",
    "market_cap": "",
    "external_rating": "",
    "internal_rating_current": "",
    "internal_rating_proposed": ""
  },

  "summary_financials": [
    { "metric": "Turnover", "y2022": null, "y2023": null, "y2024": null },
    { "metric": "GP%", "y2022": null, "y2023": null, "y2024": null },
    { "metric": "EBITDA", "y2022": null, "y2023": null, "y2024": null },
    { "metric": "Debt", "y2022": null, "y2023": null, "y2024": null },
    { "metric": "Equity", "y2022": null, "y2023": null, "y2024": null },
    { "metric": "Free cash flow", "y2022": null, "y2023": null, "y2024": null }
  ],

  "full_financials": [
    { "metric": "Turnover", "y2022": null, "y2023": null, "y2024": null, "latest_quarter": "" },
    { "metric": "GP", ... },
    { "metric": "GP%", ... },
    { "metric": "EBITDA", ... },
    { "metric": "EBITDA margin %", ... },
    { "metric": "Net profit", ... },
    { "metric": "Net Profit %", ... },
    { "metric": "Cash & Bank", ... },
    { "metric": "Inventory", ... },
    { "metric": "Debt - Current", ... },
    { "metric": "Debt - Non-current", ... },
    { "metric": "Equity", ... },
    { "metric": "Free cash flow", ... },
    { "metric": "Cash Conv. Cycle (days)", ... },
    { "metric": "Net debt / EBITDA (x)", ... },
    { "metric": "EBITDA / Interest (x)", ... },
    { "metric": "Current ratio (x)", ... }
  ],

  "liquidity": {
    "y2022": "",
    "y2023": "",
    "y2024": "",
    "notes": ""
  },

  "ratings": {
    "internal_score": "",
    "external_rating": "",
    "rationale": ""
  },

  "financial_analysis": "",
  "recommendation": "",
  "risks": ""
}

====================================================================
8. FINANCIAL ANALYSIS (12‚Äì18 PARAGRAPHS)
====================================================================
Write a professional, credit-committee-grade analysis structured under:

- Revenue & business mix  
- Profitability & extraordinary items  
- Cash flow  
- Balance sheet & leverage  
- Working capital & liquidity  
- Outlook (12‚Äì18 months)  

Rules:
- Comment on EVERY YoY change > ¬±10%, with quantified percentages + drivers.
- Reference disclosures: ‚Äú(Source: FY2024 annual report)‚Äù ‚Äî no page numbers.
- Separate core vs non-core, recurring vs extraordinary items.
- Provide forward-looking commentary tied to business model + macro factors.
- End with a short generic **Sources** line (annual report, interim, earnings releases).

====================================================================
9. RISKS AND MITIGANTS
====================================================================
Provide 3‚Äì5 key risks, each with a clear mitigant:

- Risk: ‚Ä¶  
  Mitigant: ‚Ä¶

Cover: customer concentration, supply chain dependency, leverage/refinancing, liquidity, regulatory/geopolitical risks.

====================================================================
10. STRICT OUTPUT RULES
====================================================================
- Output ONLY the JSON object, no markdown, no commentary.
- Do NOT alter field names.
- Do NOT hallucinate numeric data.
- Debt in summary must = Debt-Current + Debt-Non-current from full_financials.

END OF SYSTEM PROMPT.`;

  const userPrompt = "Prepare the JSON credit pack for obligor: " + buyer + ". Follow the schema exactly and output only the JSON object.";

  const payload = {
    model: "gpt-4.1",
    input: systemPrompt + "\n\n" + userPrompt
  };

  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("Worker response:", data);

    const content = extractContentFromResponses(data);

    if (!content) {
      alert("AI did not return any content; see console.");
      return;
    }

    let j;
    try {
      j = JSON.parse(content);
    } catch (e) {
      console.error("JSON parse failed:", e, content);
      const execBox = document.getElementById('execSummary');
      if (execBox) execBox.value = content;
      alert("AI returned non-JSON text. Raw text placed into Executive Summary.");
      return;
    }

    if (j.exec_summary) {
      const el = document.getElementById('execSummary');
      if (el) el.value = j.exec_summary;
    }
    if (j.key_highlights) {
      const el = document.getElementById('highlights');
      if (el) el.value = j.key_highlights;
    }
    if (j.recommendation) {
      const el = document.getElementById('recommend');
      if (el) el.value = j.recommendation;
    }
    if (j.risks) {
      const el = document.getElementById('risks');
      if (el) el.value = j.risks;
    }

    if (j.financial_analysis) {
      const box = document.getElementById('analysisBox');
      if (box) {
        const fa = j.financial_analysis;
        if (/<\/?[a-z][\s\S]*>/i.test(fa)) {
          box.innerHTML = fa;
        } else {
          box.innerHTML = fa
            .split(/\n\n+/)
            .map(p => "<p>" + p.replace(/\n/g, "<br>") + "</p>")
            .join("");
        }
      }
      populateSourcesFromAnalysis();
    }

    if (j.buyer) {
      const b = j.buyer;
      const map = [
        ['companyName', 'borrower'],
        ['groupParentName', 'group_parent'],
        ['obligorLegalName', 'obligor_legal_name'],
        ['country', 'country'],
        ['countryOfIncorp', 'country_of_incorp'],
        ['business', 'business_description'],
        ['coreBusinessActivities', 'business_activities'],
        ['coreBusinessCustomers', 'key_customers_main_countries'],
        ['coreBusinessWebsite', 'website'],
        ['marketCap', 'market_cap'],
        ['externalRating', 'external_rating'],
        ['internalRatingCurrent', 'internal_rating_current'],
        ['internalRatingProposed', 'internal_rating_proposed']
      ];
      map.forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el && b[key] != null) el.value = b[key];
      });
    }

    // Summary ‰∏çÂÜçÁõ¥Êé•‰ΩøÁî®Ê®°ÂûãÁöÑ summary_financialsÔºåÁî± Full Ë°® + ÂâçÁ´ØÈÄªËæëÁªü‰∏ÄËÆ°ÁÆó
    {
      const rows = Array.isArray(j.full_financials) ? j.full_financials : [];
      buildCreditMetricsTable();
      applyCreditMetricsFromFull(rows);
    }

    if (j.liquidity) {
      const liq = j.liquidity;
      const l22 = document.getElementById('liq22');
      const l23 = document.getElementById('liq23');
      const l24 = document.getElementById('liq24');
      const ln  = document.getElementById('liqNotes');
      if (l22 && liq.y2022 != null) l22.value = liq.y2022;
      if (l23 && liq.y2023 != null) l23.value = liq.y2023;
      if (l24 && liq.y2024 != null) l24.value = liq.y2024;
      if (ln  && liq.notes) ln.value = liq.notes;
    }

    if (j.ratings) {
      const r = j.ratings;
      const iscore = document.getElementById('intScore');
      const er = document.getElementById('extRating2');
      const rat = document.getElementById('ratingRationale');
      if (iscore && r.internal_score) iscore.value = r.internal_score;
      if (er && r.external_rating) er.value = r.external_rating;
      if (rat && r.rationale) rat.value = r.rationale;
    }

    // ÂÖàÁÆó Full YoYÔºåÂÜçÈáçÂª∫ SummaryÔºàÂåÖÊã¨ Debt ÂÖ¨ÂºèÔºâ
    recomputeYoYFromTables();
    alert('Auto-fill completed. Please review and adjust as needed.');

  } catch (e) {
    console.error(e);
    alert('Fetch failed: ' + e.message);
  } finally {
    const btn2 = document.getElementById('refreshBuyer');
    if (btn2) {
      btn2.disabled = false;
      btn2.innerHTML = 'Fetch Data';
    }
  }
}

// ====== Refresh analysis from tables ======
async function refreshAnalysisFromTables() {
  // Êõ¥Êñ∞ Full YoY + ÈáçÂª∫ Summary
  recomputeYoYFromTables();

  const refreshBtn = document.getElementById('refreshAnalysisBtn');
  if (refreshBtn) {
    refreshBtn.disabled = true;
    refreshBtn.textContent = "Refreshing‚Ä¶";
  }

  const buyerName =
    (safeVal('companyName') || '').trim() ||
    (safeVal('buyerLookup') || '').trim() ||
    'the obligor';

  // ÈáçÊñ∞‰ªé DOM ËØªÂèñ Full Ë°®Êï∞ÊçÆ
  const fullRows = [];
  document.querySelectorAll('#finBody tr').forEach(tr => {
    const tds = tr.querySelectorAll('td');
    if (tds.length >= 4) {
      const metricName = tds[0].textContent.trim();
      const y22Input = tds[1].querySelector('input');
      const y23Input = tds[2].querySelector('input');
      const y24Input = tds[3].querySelector('input');
      fullRows.push({
        metric: metricName,
        y2022: toNum(y22Input && y22Input.value),
        y2023: toNum(y23Input && y23Input.value),
        y2024: toNum(y24Input && y24Input.value),
        latest_quarter: ""
      });
    }
  });

  if (!fullRows.length) {
    alert('No financial rows detected to refresh analysis from.');
    if (refreshBtn) {
      refreshBtn.disabled = false;
      refreshBtn.textContent = "Refresh Analysis";
    }
    return;
  }

  // Ê†πÊçÆ Full ÊûÑÂª∫ Summary JSONÔºàTurnover/GP%/EBITDA/Debt/Equity/FCFÔºâ
  function findMetricRow(metricName) {
    return fullRows.find(r => (r.metric || '').trim() === metricName);
  }
  function val(row, year) {
    if (!row) return null;
    const key = 'y' + String(year);
    return row[key];
  }
  function debtVal(year) {
    const curRow = findMetricRow("Debt - Current");
    const ncRow = findMetricRow("Debt - Non-current");
    const cur = val(curRow, year);
    const nc = val(ncRow, year);
    if (cur == null && nc == null) return null;
    return (cur || 0) + (nc || 0);
  }

  const summaryRows = [
    {
      metric: "Turnover",
      y2022: val(findMetricRow("Turnover"), 2022),
      y2023: val(findMetricRow("Turnover"), 2023),
      y2024: val(findMetricRow("Turnover"), 2024)
    },
    {
      metric: "GP%",
      y2022: val(findMetricRow("GP%"), 2022),
      y2023: val(findMetricRow("GP%"), 2023),
      y2024: val(findMetricRow("GP%"), 2024)
    },
    {
      metric: "EBITDA",
      y2022: val(findMetricRow("EBITDA"), 2022),
      y2023: val(findMetricRow("EBITDA"), 2023),
      y2024: val(findMetricRow("EBITDA"), 2024)
    },
    {
      metric: "Debt",
      y2022: debtVal(2022),
      y2023: debtVal(2023),
      y2024: debtVal(2024)
    },
    {
      metric: "Equity",
      y2022: val(findMetricRow("Equity"), 2022),
      y2023: val(findMetricRow("Equity"), 2023),
      y2024: val(findMetricRow("Equity"), 2024)
    },
    {
      metric: "Free cash flow",
      y2022: val(findMetricRow("Free cash flow"), 2022),
      y2023: val(findMetricRow("Free cash flow"), 2023),
      y2024: val(findMetricRow("Free cash flow"), 2024)
    }
  ];

  const analysisBox = document.getElementById('analysisBox');
  if (analysisBox) {
    analysisBox.innerHTML = '<p><em>Refreshing analysis from manually adjusted tables‚Ä¶</em></p>';
  }

  const sys = `You are a senior credit analyst. The user has manually adjusted the financial tables in a credit memo.
You will receive JSON with summary_financials and full_financials representing FINAL numbers.
Do NOT override those numbers. Base your analysis strictly on the provided data.

Return ONLY a single string in message.content (no JSON object), containing a detailed financial_analysis section in HTML or markdown.
The analysis should be medium-long (roughly 12‚Äì18 structured paragraphs or bullets) with sub-headings:
- Revenue & business mix
- Profitability & extraordinary items
- Cash flow
- Balance sheet & leverage
- Working capital & liquidity
- Outlook (12‚Äì18 months).

You MUST explicitly comment on every metric where YoY change between 2022‚Äì2023 or 2023‚Äì2024 exceeds +/-10%, quantifying the % change and explaining key drivers.

Ensure any figures and percentages you mention are consistent with the table data.
Within the analysis, for each major theme (growth, margins, cash flow, leverage, liquidity, outlook),
add short textual source notes in brackets where appropriate, e.g. (Source: latest annual report) or (Source: Q4 2024 earnings release).
Do not fabricate page numbers or very specific document sections.
End with a short 'Sources' paragraph referring generically to latest annual/quarterly filings, earnings releases and investor presentations (no fabricated page numbers).`;

  const payload = {
    model: "gpt-4.1",
    input: sys + "\n\n" + JSON.stringify({
      obligor: buyerName,
      summary_financials: summaryRows,
      full_financials: fullRows
    })
  };

  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    console.log('Refresh analysis response:', data);

    const content = extractContentFromResponses(data);

    if (!content) {
      alert('No analysis content returned from refresh call.');
      return;
    }

    if (analysisBox) {
      if (/<\/?[a-z][\s\S]*>/i.test(content)) {
        analysisBox.innerHTML = content;
      } else {
        analysisBox.innerHTML = content
          .split(/\n\n+/)
          .map(p => "<p>" + p.replace(/\n/g, "<br>") + "</p>")
          .join("");
      }
    }

    populateSourcesFromAnalysis();
    alert('Analysis refreshed based on updated tables.');

  } catch (e) {
    console.error(e);
    alert('Refresh analysis failed: ' + e.message);
  } finally {
    if (refreshBtn) {
      refreshBtn.disabled = false;
      refreshBtn.textContent = "Refresh Analysis";
    }
  }
}

// ===== DOM Ready =====
document.addEventListener('DOMContentLoaded', () => {
  buildCreditMetricsTable();
  rebuildSummaryTables(); // ÂàùÂßãÁ©∫Ë°®Ôºå‰πüÂÖàÁîªÂá∫Êù•

  const chatBtn = document.getElementById('chatFloatBtn');
  const chatPanel = document.getElementById('chatPanel');
  if (chatBtn && chatPanel) {
    chatBtn.addEventListener('click', () => {
      chatPanel.style.display = chatPanel.style.display === 'block' ? 'none' : 'block';
    });
  }

  const askBtn = document.getElementById('floatAsk');
  const qBox = document.getElementById('floatQ');
  const aBox = document.getElementById('floatA');
  const chatHistory = [];

  async function runChat() {
    if (!qBox || !aBox || !askBtn) return;
    const q = (qBox.value || '').trim();
    if (!q) { aBox.textContent = 'Please type a question first.'; return; }

    askBtn.disabled = true;
    aBox.textContent = 'Thinking‚Ä¶';

    const buyerName =
      (safeVal('companyName') || '').trim() ||
      (safeVal('buyerLookup') || '').trim() ||
      'the obligor';

    const analysisEl = document.getElementById('analysisBox');
    let analysisText = '';
    if (analysisEl) {
      analysisText = (analysisEl.innerText || analysisEl.textContent || '').trim();
    }
    if (analysisText.length > 4000) {
      analysisText = analysisText.slice(0, 4000);
    }

    const sysPrompt = `You are a senior credit officer assistant. Answer follow-up questions in clear English.
Base your answers ONLY on the memo context supplied by the user (analysis extract, tables, narrative).
When the officer asks where a number or conclusion comes from, point them to the relevant section
(e.g. revenue table, EBITDA row, liquidity notes, bond maturity paragraph) instead of inventing new data.
If the information is not available in the context, say so explicitly and suggest likely public sources
(latest 20-F/10-K, earnings releases, bond offering circular), without fabricating page numbers.
Keep answers concise but technically sound, suitable for an investment committee discussion.`;

    const userContent = [
      "Question from credit officer: " + q,
      "",
      "Current obligor: " + buyerName,
      "",
      "Extract of automated analysis and memo context (truncated):",
      analysisText
    ].join("\n");

    const payload = {
      model: "gpt-4.1",
      input: sysPrompt + "\n\n" + userContent
    };

    try {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }

      const data = await res.json();
      const content = extractContentFromResponses(data);

      if (!content) {
        aBox.textContent = "Chat failed: empty response from Worker.";
        return;
      }

      chatHistory.push(
        { role: "user", content: q },
        { role: "assistant", content }
      );

      aBox.innerHTML = content
        .split(/\n\n+/)
        .map(p => "<p>" + p.replace(/\n/g, "<br>") + "</p>")
        .join("");

    } catch (e) {
      console.error(e);
      aBox.textContent = "Chat failed: " + e.message;
    } finally {
      askBtn.disabled = false;
    }
  }

  if (askBtn) {
    askBtn.addEventListener('click', () => { runChat(); });
  }

  const fetchBtn = document.getElementById('refreshBuyer');
  if (fetchBtn && !fetchBtn._v83Bound) {
    fetchBtn.addEventListener('click', autoFetchBuyer);
    fetchBtn._v83Bound = true;
  }

  // Onboarding: Next / Skip buttons
  const nextBtn = document.getElementById("tourNextBtn");
  const skipBtn = document.getElementById("tourSkipBtn");
  if (nextBtn) {
    nextBtn.addEventListener("click", () => {
      if (currentTourStep < TOUR_STEPS.length - 1) {
        currentTourStep += 1;
        renderTourStep();
      } else {
        endTour();
      }
    });
  }
  if (skipBtn) {
    skipBtn.addEventListener("click", () => {
      endTour();
    });
  }

  // Hidden reset: triple-click title
  const titleEl = document.getElementById("memoTitle");
  if (titleEl) {
    let clickCount = 0;
    let timer = null;
    titleEl.addEventListener("click", () => {
      clickCount += 1;
      if (clickCount === 1) {
        timer = setTimeout(() => {
          clickCount = 0;
        }, 600);
      }
      if (clickCount >= 3) {
        clickCount = 0;
        if (timer) clearTimeout(timer);
        console.log("Tour reset via title triple-click");
        resetTour();
      }
    });
  }

  // First load: maybe show tour
  maybeStartTourOnLoad();
});
</script>

<script>
// safety re-bind for Fetch Data button
(function(){
  function bindFetch() {
    try {
      var btn = document.getElementById('refreshBuyer');
      if (btn && !btn._v83Bound) {
        btn.addEventListener('click', autoFetchBuyer);
        btn._v83Bound = true;
        console.log("autoFetchBuyer bound (safety helper)");
      }
    } catch (e) {
      console.error("bindFetch error", e);
    }
  }
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(bindFetch, 0);
  } else {
    document.addEventListener('DOMContentLoaded', bindFetch);
  }
  setTimeout(bindFetch, 1000);
})();
</script>

</body>
</html>
